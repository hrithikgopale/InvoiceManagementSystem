@{
    ViewData["Title"] = "Inventory Management";
}

<div class="container mt-4">

    <h4 class="mb-4">Inventory Management</h4>

    <!-- Add Inventory Item -->
    <div class="card mb-4 p-3 shadow-sm">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="itemName" class="form-label">Name</label>
                <input type="text" id="itemName" class="form-control" placeholder="Name">
            </div>
            <div class="col-md-3">
                <label for="itemDescription" class="form-label">Description</label>
                <input type="text" id="itemDescription" class="form-control" placeholder="Description">
            </div>
            <div class="col-md-2">
                <label for="itemUnitPrice" class="form-label">Unit Price</label>
                <input type="number" id="itemUnitPrice" class="form-control" placeholder="Unit Price">
            </div>
            <div class="col-md-2">
                <label for="itemStockQuantity" class="form-label">Stock Quantity</label>
                <input type="number" id="itemStockQuantity" class="form-control" placeholder="Stock Quantity">
            </div>
            <div class="col-md-2 d-grid">
                <button id="addItemBtn" class="btn btn-primary">Add Item</button>
            </div>
        </div>
    </div>

    <!-- Inventory Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <table id="inventoryTable" class="table table-bordered table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Unit Price</th>
                        <th>Stock</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows loaded dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Edit Inventory Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editItemId" />
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" id="editItemName" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" id="editItemDescription" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Unit Price</label>
                        <input type="number" id="editItemUnitPrice" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Stock Quantity</label>
                        <input type="number" id="editItemStockQuantity" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="saveEditItem" class="btn btn-success">Save Changes</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- CSS/JS Dependencies -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

@section Scripts {
    <script>
        $(document).ready(function(){

            var editModal = new bootstrap.Modal(document.getElementById('editItemModal'));

            // Load all items
            function loadItems(){
                $.getJSON('/Inventory/GetAll', function(data){
                    var tbody = $('#inventoryTable tbody');
                    tbody.empty();
                    $.each(data, function(i, item){
                        tbody.append('<tr data-id="'+item.id+'">'+
                            '<td>'+item.name+'</td>'+
                            '<td>'+item.description+'</td>'+
                            '<td>'+item.unitPrice+'</td>'+
                            '<td>'+item.stockQuantity+'</td>'+
                            '<td>'+
                                '<button class="editItemBtn btn btn-sm btn-warning me-1" title="Edit"><i class="fas fa-pencil-alt"></i></button>'+
                                '<button class="deleteItemBtn btn btn-sm btn-danger" title="Delete"><i class="fas fa-trash-alt"></i></button>'+
                            '</td>'+
                        '</tr>');
                    });
                });
            }

            loadItems();

            // Validation function
            function validateInventoryItem(name, unitPrice, stock){
                if(!name || name.trim() === ''){
                    toastr.error('Name is required');
                    return false;
                }
                if(!unitPrice || parseFloat(unitPrice) <= 0){
                    toastr.error('Unit Price must be greater than 0');
                    return false;
                }
                if(!stock || parseInt(stock) < 0){
                    toastr.error('Stock Quantity cannot be negative');
                    return false;
                }
                return true;
            }

            // Add Item
            $('#addItemBtn').click(function(){
                var name = $('#itemName').val();
                var desc = $('#itemDescription').val();
                var unitPrice = $('#itemUnitPrice').val();
                var stock = $('#itemStockQuantity').val();

                if(!validateInventoryItem(name, unitPrice, stock)) return;

                $.post('/Inventory/CreateAjax', { Name:name, Description:desc, UnitPrice:unitPrice, StockQuantity:stock }, function(data){
                    if(data.success){
                        loadItems();
                        $('#itemName, #itemDescription, #itemUnitPrice, #itemStockQuantity').val('');
                        toastr.success('Item added successfully');
                    } else {
                        toastr.error('Error adding item');
                    }
                });
            });

            // Edit Item
            $(document).on('click', '.editItemBtn', function(){
                var row = $(this).closest('tr');
                var id = row.data('id');
                $('#editItemId').val(id);
                $('#editItemName').val(row.find('td:eq(0)').text());
                $('#editItemDescription').val(row.find('td:eq(1)').text());
                $('#editItemUnitPrice').val(row.find('td:eq(2)').text());
                $('#editItemStockQuantity').val(row.find('td:eq(3)').text());
                editModal.show();
            });

            // Save Edit
            $('#saveEditItem').click(function(){
                var id = $('#editItemId').val();
                var name = $('#editItemName').val();
                var desc = $('#editItemDescription').val();
                var unitPrice = $('#editItemUnitPrice').val();
                var stock = $('#editItemStockQuantity').val();

                if(!validateInventoryItem(name, unitPrice, stock)) return;

                $.post('/Inventory/EditAjax', { id:id, Name:name, Description:desc, UnitPrice:unitPrice, StockQuantity:stock }, function(data){
                    if(data.success){
                        loadItems();
                        editModal.hide();
                        toastr.success('Item updated successfully');
                    } else {
                        toastr.error(data.message || 'Error updating item');
                    }
                });
            });

            // Delete Item
            $(document).on('click', '.deleteItemBtn', function(){
                if(!confirm('Are you sure you want to delete this item?')) return;
                var row = $(this).closest('tr');
                var id = row.data('id');

                $.post('/Inventory/DeleteAjax', { id:id }, function(data){
                    if(data.success){
                        loadItems();
                        toastr.success('Item deleted successfully');
                    } else {
                        toastr.error(data.message || 'Error deleting item');
                    }
                });
            });

        });
    </script>
}
